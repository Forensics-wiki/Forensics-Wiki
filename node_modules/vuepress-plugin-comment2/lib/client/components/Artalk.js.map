{"version":3,"file":"Artalk.js","sources":["../../../src/client/components/Artalk.ts"],"sourcesContent":["import { usePageData, useSiteData } from \"@vuepress/client\";\nimport type Artalk from \"artalk\";\nimport type { VNode } from \"vue\";\nimport {\n  defineComponent,\n  h,\n  nextTick,\n  onMounted,\n  ref,\n  shallowRef,\n  watch,\n} from \"vue\";\nimport { LoadingIcon, isString } from \"vuepress-shared/client\";\n\nimport { useArtalkOptions } from \"../helpers/index.js\";\n\nimport \"artalk/dist/Artalk.css\";\nimport \"../styles/artalk.scss\";\n\nexport default defineComponent({\n  // eslint-disable-next-line vue/multi-word-component-names\n  name: \"Artalk\",\n\n  props: {\n    /**\n     * The path of the comment\n     */\n    identifier: {\n      type: String,\n      required: true,\n    },\n\n    /**\n     * Whether the component is in darkmode\n     *\n     * 组件是否处于夜间模式\n     */\n    darkmode: Boolean,\n  },\n\n  setup: (props) => {\n    const artalkOptions = useArtalkOptions();\n    const page = usePageData();\n    const site = useSiteData();\n\n    const loaded = ref(false);\n    const artalkContainer = shallowRef<HTMLDivElement>();\n\n    let artalk: Artalk.default | null = null;\n\n    const enableArtalk = isString(artalkOptions.server);\n\n    const initArtalk = async (): Promise<void> => {\n      const [{ default: _Artalk }] = await Promise.all([\n        import(/* webpackChunkName: \"artalk\" */ \"artalk/dist/Artalk.es.js\"),\n        new Promise<void>((resolve) => {\n          setTimeout(() => {\n            resolve();\n          }, artalkOptions.delay || 800);\n        }),\n      ]);\n\n      // FIXME: Types issue\n      const Artalk = _Artalk as unknown as typeof _Artalk.default;\n\n      loaded.value = true;\n      await nextTick();\n\n      try {\n        artalk = new Artalk({\n          useBackendConf: false,\n          site: site.value.title,\n          pageTitle: page.value.title,\n          ...artalkOptions,\n          el: artalkContainer.value!,\n          pageKey: props.identifier,\n          darkMode: props.darkmode,\n        });\n\n        if (artalkOptions.useBackendConf)\n          artalk.on(\"conf-loaded\", () => {\n            artalk!.setDarkMode(props.darkmode);\n          });\n      } catch (err) {\n        // FIXME: Not sure what the issue is, relevant issue:\n        // https://github.com/vuepress/vuepress-next/issues/1249\n        // https://github.com/ArtalkJS/Artalk/discussions/367\n      }\n    };\n\n    onMounted(() => {\n      watch(\n        () => page.value.path,\n        async () => {\n          try {\n            artalk?.destroy();\n          } catch (err) {\n            // do nothing\n          }\n          await initArtalk();\n        },\n        { immediate: true },\n      );\n\n      watch(\n        () => props.darkmode,\n        (value) => {\n          artalk?.setDarkMode(value);\n        },\n      );\n    });\n\n    return (): VNode | null =>\n      enableArtalk\n        ? h(\"div\", { class: \"artalk-wrapper\" }, [\n            loaded.value ? null : h(LoadingIcon),\n            h(\"div\", { ref: artalkContainer }),\n          ])\n        : null;\n  },\n});\n"],"names":["Artalk","defineComponent","props","artalkOptions","useArtalkOptions","page","usePageData","site","useSiteData","loaded","ref","artalkContainer","shallowRef","artalk","enableArtalk","isString","initArtalk","_Artalk","resolve","nextTick","onMounted","watch","value","h","LoadingIcon"],"mappings":"uVAmBA,IAAAA,EAAeC,EAAgB,CAE7B,KAAM,SAEN,MAAO,CAIL,WAAY,CACV,KAAM,OACN,SAAU,EACZ,EAOA,SAAU,OACZ,EAEA,MAAQC,GAAU,CAChB,MAAMC,EAAgBC,EAAiB,EACjCC,EAAOC,EAAY,EACnBC,EAAOC,EAEPC,EAAAA,EAASC,EAAI,EAAK,EAClBC,EAAkBC,EAA2B,EAEnD,IAAIC,EAAgC,KAEpC,MAAMC,EAAeC,EAASZ,EAAc,MAAM,EAE5Ca,EAAa,SAA2B,CAC5C,KAAM,CAAC,CAAE,QAASC,CAAQ,CAAC,EAAI,MAAM,QAAQ,IAAI,CAC/C,OAAwC,0BAA0B,EAClE,IAAI,QAAeC,GAAY,CAC7B,WAAW,IAAM,CACfA,EAAAA,CACF,EAAGf,EAAc,OAAS,GAAG,CAC/B,CAAC,CACH,CAAC,EAGKH,EAASiB,EAEfR,EAAO,MAAQ,GACf,MAAMU,EAAAA,EAEN,GAAI,CACFN,EAAS,IAAIb,EAAO,CAClB,eAAgB,GAChB,KAAMO,EAAK,MAAM,MACjB,UAAWF,EAAK,MAAM,MACtB,GAAGF,EACH,GAAIQ,EAAgB,MACpB,QAAST,EAAM,WACf,SAAUA,EAAM,QAClB,CAAC,EAEGC,EAAc,gBAChBU,EAAO,GAAG,cAAe,IAAM,CAC7BA,EAAQ,YAAYX,EAAM,QAAQ,CACpC,CAAC,CACL,MAAc,EAKhB,EAEA,OAAAkB,EAAU,IAAM,CACdC,EACE,IAAMhB,EAAK,MAAM,KACjB,SAAY,CACV,GAAI,CACFQ,GAAA,MAAAA,EAAQ,QACV,CAAA,MAAc,CAAA,CAGd,MAAMG,EAAW,CACnB,EACA,CAAE,UAAW,EAAK,CACpB,EAEAK,EACE,IAAMnB,EAAM,SACXoB,GAAU,CACTT,GAAA,MAAAA,EAAQ,YAAYS,CACtB,CAAA,CACF,CACF,CAAC,EAEM,IACLR,EACIS,EAAE,MAAO,CAAE,MAAO,gBAAiB,EAAG,CACpCd,EAAO,MAAQ,KAAOc,EAAEC,CAAW,EACnCD,EAAE,MAAO,CAAE,IAAKZ,CAAgB,CAAC,CACnC,CAAC,EACD,IACR,CACF,CAAC"}